<Project>
  <!-- Only participate if enabled and there is a doc file -->
  <PropertyGroup>
    <_Xml2Doc_CanRun Condition="'$(Xml2Doc_Enabled)'=='true' and '$(DocumentationFile)'!='' and Exists('$(DocumentationFile)')">true</_Xml2Doc_CanRun>
  </PropertyGroup>

  <!-- Write a stable "fingerprint" file representing options that affect output -->
  <Target Name="Xml2Doc_WriteFingerprint"
          Condition="'$(_Xml2Doc_CanRun)'=='true'">
    <PropertyGroup>
      <_Xml2Doc_Fingerprint>$(Xml2Doc_SingleFile)|$(Xml2Doc_OutputFile)|$(Xml2Doc_OutputDir)|$(Xml2Doc_FileNameMode)|$(Xml2Doc_RootNamespaceToTrim)|$(Xml2Doc_CodeBlockLanguage)</_Xml2Doc_Fingerprint>
    </PropertyGroup>
    <WriteLinesToFile
        File="$(Xml2Doc_FingerprintFile)"
        Lines="$(_Xml2Doc_Fingerprint)"
        Overwrite="true"
        Encoding="UTF-8" />
  </Target>

  <!-- Generate docs after successful compilation -->
  <Target Name="Xml2Doc_Generate"
          AfterTargets="CoreCompile"
          DependsOnTargets="Xml2Doc_WriteFingerprint"
          Condition="'$(_Xml2Doc_CanRun)'=='true'"
          Inputs="$(DocumentationFile);$(Xml2Doc_FingerprintFile)"
          Outputs="$(Xml2Doc_OutputStamp)">
    <Message Importance="Low" Text="Xml2Doc: xml='$(DocumentationFile)' single=$(Xml2Doc_SingleFile) outDir='$(Xml2Doc_OutputDir)' outFile='$(Xml2Doc_OutputFile)'" />

    <GenerateMarkdownFromXmlDoc
        Xml="$(DocumentationFile)"
        SingleFile="$(Xml2Doc_SingleFile)"
        OutputFile="$(Xml2Doc_OutputFile)"
        OutputDir="$(Xml2Doc_OutputDir)"
        FileNameMode="$(Xml2Doc_FileNameMode)"
        RootNamespaceToTrim="$(Xml2Doc_RootNamespaceToTrim)"
        CodeBlockLanguage="$(Xml2Doc_CodeBlockLanguage)"
        ReportPath="$(Xml2Doc_ReportPath)"
        DryRun="$(Xml2Doc_DryRun)"
        Diff="$(Xml2Doc_Diff)">
      <Output TaskParameter="GeneratedFiles" ItemName="Xml2Doc_GeneratedFiles" />
      <Output TaskParameter="ReportPathOut" PropertyName="Xml2Doc_ReportPathOut" />
      <Output TaskParameter="DidWork" PropertyName="Xml2Doc_DidWork" />
    </GenerateMarkdownFromXmlDoc>

    <!-- Touch the stamp to satisfy incremental Outputs -->
    <WriteLinesToFile
        File="$(Xml2Doc_OutputStamp)"
        Lines="generated: @(Xml2Doc_GeneratedFiles,';') | report: $(Xml2Doc_ReportPathOut) | time: $([System.DateTime]::Now.ToString('o'))"
        Overwrite="true"
        Encoding="UTF-8" />

    <!-- Surface generated files for other targets/logging -->
    <ItemGroup>
      <FileWrites Include="@(Xml2Doc_GeneratedFiles)" />
    </ItemGroup>

    <Message Importance="High" Condition="'$(Xml2Doc_DidWork)'=='true'" Text="Xml2Doc: generated @(Xml2Doc_GeneratedFiles,';')" />
    <Message Importance="Low"  Condition="'$(Xml2Doc_DidWork)'!='true'" Text="Xml2Doc: up-to-date (skipped)" />
  </Target>
</Project>
