<Project>
  <!-- Decide preferred TFM based on MSBuild runtime -->
  <PropertyGroup>
    <!-- ORIGINAL: keep for reference but superseded by the _TaskTfm/_TaskPath block below -->
    <!--
    <_Xml2DocPreferredTfm>net8.0</_Xml2DocPreferredTfm>
    <_Xml2DocPreferredTfm Condition="'$(MSBuildRuntimeType)'=='Full'">net472</_Xml2DocPreferredTfm>

    <_Xml2DocTaskDll>$(MSBuildThisFileDirectory)..\lib\$(_Xml2DocPreferredTfm)\Xml2Doc.MSBuild.dll</_Xml2DocTaskDll>
    <_Xml2DocTaskDll Condition="!Exists('$(_Xml2DocTaskDll)')">$(MSBuildThisFileDirectory)..\lib\net8.0\Xml2Doc.MSBuild.dll</_Xml2DocTaskDll>
    <_Xml2DocTaskDll Condition="!Exists('$(_Xml2DocTaskDll)')">$(MSBuildThisFileDirectory)..\lib\net472\Xml2Doc.MSBuild.dll</_Xml2DocTaskDll>
    -->

    <!-- NEW (single source of truth): pick task TFM by MSBuild runtime and compute path -->
    <_Xml2Doc_TaskTfm Condition="'$(MSBuildRuntimeType)' == 'Core'">net8.0</_Xml2Doc_TaskTfm>
    <_Xml2Doc_TaskTfm Condition="'$(_Xml2Doc_TaskTfm)' == ''">net472</_Xml2Doc_TaskTfm>
    <_Xml2Doc_TaskPath>$(MSBuildThisFileDirectory)..\lib\$(_Xml2Doc_TaskTfm)\Xml2Doc.MSBuild.dll</_Xml2Doc_TaskPath>
  </PropertyGroup>

  <!-- ORIGINAL (INVALID LOCATION): MakeDir cannot be at project root -->
  <!--
  <MakeDir Directories="$(Xml2Doc_OutputDir)" Condition="!Exists('$(Xml2Doc_OutputDir)')" />
  -->

  <!-- Load the task from the resolved path -->
  <UsingTask
    TaskName="Xml2Doc.MSBuild.GenerateMarkdownFromXmlDoc"
    AssemblyFile="$(_Xml2Doc_TaskPath)" />

  <!-- ORIGINAL: verify target checked old variable; switch to _Xml2Doc_TaskPath -->
  <!--
  <Target Name="Xml2Doc_VerifyTaskAssembly" BeforeTargets="Xml2Doc_Generate" Condition="!Exists('$(_Xml2DocTaskDll)')">
    <Warning Text="Xml2Doc task assembly not found at $(_Xml2DocTaskDll). Package layout mismatch?" />
  </Target>
  -->
  <Target Name="Xml2Doc_VerifyTaskAssembly"
          BeforeTargets="Xml2Doc_Generate"
          Condition="!Exists('$(_Xml2Doc_TaskPath)')">
    <Warning Text="Xml2Doc task assembly not found at $(_Xml2Doc_TaskPath). Package layout mismatch?" />
  </Target>

  <Target Name="_Xml2Doc_LogChosenTask" BeforeTargets="Build" Condition="'$(Xml2Doc_LogChosenTask)'=='true'">
    <Message Text="Xml2Doc task: $(_Xml2Doc_TaskPath) (TFM=$(_Xml2Doc_TaskTfm), MSBuildRuntimeType=$(MSBuildRuntimeType))" Importance="Low" />
  </Target>

  <!-- ORIGINAL (SECOND UsingTask): remove to avoid double registration / path disagreement -->
  <!--
  <UsingTask TaskName="GenerateMarkdownFromXmlDoc" AssemblyFile="$(_Xml2DocTaskDll)" />
  -->

  <PropertyGroup>
    <_Xml2Doc_CanRun Condition="'$(Xml2Doc_Enabled)'=='true' and '$(DocumentationFile)'!='' and Exists('$(DocumentationFile)')">true</_Xml2Doc_CanRun>
  </PropertyGroup>

  <!-- NEW: compute SHA256 of $(DocumentationFile) + combine with options,
            and only update fingerprint file if content actually changes. -->
  <Target Name="Xml2Doc_ComputeFingerprint"
          Condition="'$(_Xml2Doc_CanRun)'=='true'">
    <!-- 1) Hash the XML doc -->
    <GetFileHash Files="$(DocumentationFile)" Algorithm="SHA256">
      <Output TaskParameter="Items" ItemName="_Xml2Doc_HashItem" />
    </GetFileHash>

    <!-- 2) Build the normalized options fingerprint -->
    <PropertyGroup>
      <_Xml2Doc_Options>$(Xml2Doc_SingleFile)|$(Xml2Doc_OutputFile)|$(Xml2Doc_OutputDir)|$(Xml2Doc_FileNameMode)|$(Xml2Doc_RootNamespaceToTrim)|$(Xml2Doc_CodeBlockLanguage)</_Xml2Doc_Options>
      <_Xml2Doc_Hash>$(_Xml2Doc_Hash)</_Xml2Doc_Hash>
      <!-- will be set below from item metadata -->
    </PropertyGroup>

    <!-- Pull Hash metadata out of the item (there is exactly one file) -->
    <ItemGroup>
      <_Xml2Doc_HashValue Include="@(_Xml2Doc_HashItem->'%(Hash)')" />
    </ItemGroup>
    <PropertyGroup>
      <_Xml2Doc_Hash>@(_Xml2Doc_HashValue)</_Xml2Doc_Hash>
      <_Xml2Doc_Fingerprint>$(_Xml2Doc_Hash)|$(_Xml2Doc_Options)</_Xml2Doc_Fingerprint>
    </PropertyGroup>

    <!-- 3) Read existing fingerprint (if any) and only write when different -->
    <ReadLinesFromFile File="$(Xml2Doc_FingerprintFile)" Condition="Exists('$(Xml2Doc_FingerprintFile)')">
      <Output TaskParameter="Lines" ItemName="_Xml2Doc_ExistingFingerprint" />
    </ReadLinesFromFile>

    <PropertyGroup>
      <_Xml2Doc_Existing>@(_Xml2Doc_ExistingFingerprint)</_Xml2Doc_Existing>
    </PropertyGroup>

    <WriteLinesToFile
        File="$(Xml2Doc_FingerprintFile)"
        Lines="$(_Xml2Doc_Fingerprint)"
        Overwrite="true"
        Encoding="UTF-8"
        Condition="'$(_Xml2Doc_Existing)' != '$(_Xml2Doc_Fingerprint)'" />

    <Message Importance="Low" Text="Xml2Doc: fingerprint $(_Xml2Doc_Fingerprint)" />
  </Target>

  <Target Name="Xml2Doc_Generate"
          AfterTargets="CoreCompile"
          DependsOnTargets="Xml2Doc_WriteFingerprint"
          Condition="'$(_Xml2Doc_CanRun)'=='true'"
          Inputs="$(DocumentationFile);$(Xml2Doc_FingerprintFile)"
          Outputs="$(Xml2Doc_OutputStamp)">

    <Message Importance="Low" Text="Xml2Doc: xml='$(DocumentationFile)' single=$(Xml2Doc_SingleFile) outDir='$(Xml2Doc_OutputDir)' outFile='$(Xml2Doc_OutputFile)'" />

    <!-- Precompute the single-file directory to avoid nested property functions in Condition -->
    <PropertyGroup>
      <!-- OLD inline usage (commented below) called Path.GetDirectoryName inside the Condition and caused MSB4092 -->
      <_Xml2Doc_OutputFileDir>$([System.IO.Path]::GetDirectoryName($(Xml2Doc_OutputFile)))</_Xml2Doc_OutputFileDir>
    </PropertyGroup>

    <!-- NEW: Create destination directories INSIDE the target (valid location) -->
    <MakeDir Directories="$(Xml2Doc_OutputDir)"
             Condition="'$(Xml2Doc_SingleFile)'!='true' and !Exists('$(Xml2Doc_OutputDir)')" />

    <!-- OLD (kept for reference; was triggering MSB4092 due to nested quotes/functions)
    <MakeDir Directories="$([System.IO.Path]::GetDirectoryName('$(Xml2Doc_OutputFile)'))"
             Condition="'$(Xml2Doc_SingleFile)'=='true' and '$(Xml2Doc_OutputFile)'!='' and !Exists('$([System.IO.Path]::GetDirectoryName('$(Xml2Doc_OutputFile)'))')" />
    -->

    <!-- NEW: use the precomputed directory property to keep Condition simple -->
    <MakeDir Directories="$(_Xml2Doc_OutputFileDir)"
             Condition="'$(Xml2Doc_SingleFile)'=='true'
                        and '$(_Xml2Doc_OutputFileDir)'!=''
                        and !Exists('$(_Xml2Doc_OutputFileDir)')" />

    <GenerateMarkdownFromXmlDoc
        XmlPath="$(DocumentationFile)"
        SingleFile="$(Xml2Doc_SingleFile)"
        OutputFile="$(Xml2Doc_OutputFile)"
        OutputDirectory="$(Xml2Doc_OutputDir)"
        FileNameMode="$(Xml2Doc_FileNameMode)"
        RootNamespaceToTrim="$(Xml2Doc_RootNamespaceToTrim)"
        CodeBlockLanguage="$(Xml2Doc_CodeBlockLanguage)"
        ReportPath="$(Xml2Doc_ReportPath)"
        DryRun="$(Xml2Doc_DryRun)"
        Diff="$(Xml2Doc_Diff)"
        Fingerprint="$(_Xml2Doc_Fingerprint)"
        XmlSha256="$(_Xml2Doc_Hash)">
      <Output TaskParameter="GeneratedFiles" ItemName="Xml2Doc_GeneratedFiles" />
      <Output TaskParameter="ReportPathOut" PropertyName="Xml2Doc_ReportPathOut" />
      <Output TaskParameter="DidWork" PropertyName="Xml2Doc_DidWork" />
    </GenerateMarkdownFromXmlDoc>

    <!-- Join item list into a property to avoid MSB4012 when writing the stamp -->
    <PropertyGroup>
      <_Xml2Doc_GeneratedJoined>@(Xml2Doc_GeneratedFiles,';')</_Xml2Doc_GeneratedJoined>
      <_Xml2Doc_ReportDisplay Condition="'$(Xml2Doc_ReportPathOut)'!=''">$(Xml2Doc_ReportPathOut)</_Xml2Doc_ReportDisplay>
      <_Xml2Doc_ReportDisplay Condition="'$(_Xml2Doc_ReportDisplay)'=='' and '$(Xml2Doc_ReportPath)'!=''">$(Xml2Doc_ReportPath)</_Xml2Doc_ReportDisplay>
      <_Xml2Doc_ReportDisplay Condition="'$(_Xml2Doc_ReportDisplay)'==''">n/a</_Xml2Doc_ReportDisplay>
    </PropertyGroup>

    <WriteLinesToFile File="$(Xml2Doc_OutputStamp)"
                      Lines="generated: $(_Xml2Doc_GeneratedJoined) | report: $(_Xml2Doc_ReportDisplay) | time: $([System.DateTime]::Now.ToString('o'))"
                      Overwrite="true"
                      Encoding="UTF-8" />

    <ItemGroup>
      <FileWrites Include="@(Xml2Doc_GeneratedFiles)" />
    </ItemGroup>

    <Message Importance="High" Condition="'$(Xml2Doc_DidWork)'=='true'" Text="Xml2Doc: generated @(Xml2Doc_GeneratedFiles,';')" />
    <Message Importance="Low"  Condition="'$(Xml2Doc_DidWork)'!='true'" Text="Xml2Doc: up-to-date (skipped)" />
  </Target>
</Project>
