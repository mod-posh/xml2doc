<Project>
  <PropertyGroup>
    <!-- Decide preferred TFM based on MSBuild runtime -->
    <_Xml2DocPreferredTfm>net8.0</_Xml2DocPreferredTfm>
    <_Xml2DocPreferredTfm Condition="'$(MSBuildRuntimeType)'=='Full'">net472</_Xml2DocPreferredTfm>

    <!-- Base resolution: prefer runtime-appropriate TFM under lib/ -->
    <_Xml2DocTaskDll>$(MSBuildThisFileDirectory)..\lib\$(_Xml2DocPreferredTfm)\Xml2Doc.MSBuild.dll</_Xml2DocTaskDll>

    <!-- Fallbacks if preferred not found -->
    <_Xml2DocTaskDll Condition="!Exists('$(_Xml2DocTaskDll)')">$(MSBuildThisFileDirectory)..\lib\net8.0\Xml2Doc.MSBuild.dll</_Xml2DocTaskDll>
    <_Xml2DocTaskDll Condition="!Exists('$(_Xml2DocTaskDll)')">$(MSBuildThisFileDirectory)..\lib\net472\Xml2Doc.MSBuild.dll</_Xml2DocTaskDll>
  </PropertyGroup>

  <!-- For MSBuild on .NET (dotnet build), prefer net8.0; otherwise .NET Framework -->
  <PropertyGroup>
    <_Xml2Doc_TaskTfm Condition="'$(MSBuildRuntimeType)' == 'Core'">net8.0</_Xml2Doc_TaskTfm>
    <_Xml2Doc_TaskTfm Condition="'$(_Xml2Doc_TaskTfm)' == ''">net472</_Xml2Doc_TaskTfm>
    <_Xml2Doc_TaskPath>$(MSBuildThisFileDirectory)..\lib\$(_Xml2Doc_TaskTfm)\Xml2Doc.MSBuild.dll</_Xml2Doc_TaskPath>
  </PropertyGroup>

  <UsingTask
    TaskName="Xml2Doc.MSBuild.GenerateMarkdownFromXmlDoc"
    AssemblyFile="$(_Xml2Doc_TaskPath)" />

  <!-- Optional: warn if DLL still not found -->
  <Target Name="Xml2Doc_VerifyTaskAssembly" BeforeTargets="Xml2Doc_Generate" Condition="!Exists('$(_Xml2DocTaskDll)')">
    <Warning Text="Xml2Doc task assembly not found at $(_Xml2DocTaskDll). Package layout mismatch?" />
  </Target>

  <Target Name="_Xml2Doc_LogChosenTask" BeforeTargets="Build" Condition="'$(Xml2Doc_LogChosenTask)'=='true'">
    <Message Text="Xml2Doc task: $(_Xml2Doc_TaskPath) (TFM=$(_Xml2Doc_TaskTfm), MSBuildRuntimeType=$(MSBuildRuntimeType))" Importance="Low" />
  </Target>
  
  <UsingTask TaskName="GenerateMarkdownFromXmlDoc" AssemblyFile="$(_Xml2DocTaskDll)" />

  <PropertyGroup>
    <_Xml2Doc_CanRun Condition="'$(Xml2Doc_Enabled)'=='true' and '$(DocumentationFile)'!='' and Exists('$(DocumentationFile)')">true</_Xml2Doc_CanRun>
  </PropertyGroup>

  <Target Name="Xml2Doc_WriteFingerprint" Condition="'$(_Xml2Doc_CanRun)'=='true'">
    <PropertyGroup>
      <_Xml2Doc_Fingerprint>$(Xml2Doc_SingleFile)|$(Xml2Doc_OutputFile)|$(Xml2Doc_OutputDir)|$(Xml2Doc_FileNameMode)|$(Xml2Doc_RootNamespaceToTrim)|$(Xml2Doc_CodeBlockLanguage)</_Xml2Doc_Fingerprint>
    </PropertyGroup>
    <WriteLinesToFile File="$(Xml2Doc_FingerprintFile)" Lines="$(_Xml2Doc_Fingerprint)" Overwrite="true" Encoding="UTF-8" />
  </Target>

  <Target Name="Xml2Doc_Generate"
          AfterTargets="CoreCompile"
          DependsOnTargets="Xml2Doc_WriteFingerprint"
          Condition="'$(_Xml2Doc_CanRun)'=='true'"
          Inputs="$(DocumentationFile);$(Xml2Doc_FingerprintFile)"
          Outputs="$(Xml2Doc_OutputStamp)">
    <Message Importance="Low" Text="Xml2Doc: xml='$(DocumentationFile)' single=$(Xml2Doc_SingleFile) outDir='$(Xml2Doc_OutputDir)' outFile='$(Xml2Doc_OutputFile)'" />

    <GenerateMarkdownFromXmlDoc
        Xml="$(DocumentationFile)"
        SingleFile="$(Xml2Doc_SingleFile)"
        OutputFile="$(Xml2Doc_OutputFile)"
        OutputDir="$(Xml2Doc_OutputDir)"
        FileNameMode="$(Xml2Doc_FileNameMode)"
        RootNamespaceToTrim="$(Xml2Doc_RootNamespaceToTrim)"
        CodeBlockLanguage="$(Xml2Doc_CodeBlockLanguage)"
        ReportPath="$(Xml2Doc_ReportPath)"
        DryRun="$(Xml2Doc_DryRun)"
        Diff= "$(Xml2Doc_Diff)">
      <Output TaskParameter="GeneratedFiles" ItemName="Xml2Doc_GeneratedFiles" />
      <Output TaskParameter="ReportPathOut" PropertyName="Xml2Doc_ReportPathOut" />
      <Output TaskParameter="DidWork" PropertyName="Xml2Doc_DidWork" />
    </GenerateMarkdownFromXmlDoc>

    <WriteLinesToFile File="$(Xml2Doc_OutputStamp)"
                      Lines="generated: @(Xml2Doc_GeneratedFiles,';') | report: $(Xml2Doc_ReportPathOut) | time: $([System.DateTime]::Now.ToString('o'))"
                      Overwrite="true"
                      Encoding="UTF-8" />

    <ItemGroup>
      <FileWrites Include="@(Xml2Doc_GeneratedFiles)" />
    </ItemGroup>

    <Message Importance="High" Condition="'$(Xml2Doc_DidWork)'=='true'" Text="Xml2Doc: generated @(Xml2Doc_GeneratedFiles,';')" />
    <Message Importance="Low"  Condition="'$(Xml2Doc_DidWork)'!='true'" Text="Xml2Doc: up-to-date (skipped)" />
  </Target>
</Project>
